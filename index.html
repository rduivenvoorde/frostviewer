<!DOCTYPE html>
<head>
<meta charset="utf-8">
<!-- leaflet map -->
<style>
  #map{ width:100%;height:400px; }

  iframe{
    width:100%;
    height: 300px;
    border: white
  }
</style>

<!-- https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.4.0/leaflet.js -->
<link rel="stylesheet" href="css/leaflet.css"/>
<script src="lib/leaflet.js"></script>
<script src="lib/L.LabeledCircle.js"></script>
<!-- https://code.jquery.com/jquery-3.3.1.min.js -->
<script type="text/javascript" src="lib/jquery-3.3.1.min.js"></script>

<script>
$(function() {
  var featuresurl = window.location.protocol+'//'+window.location.hostname+'/cgi-bin/sta_proxy.py?$count=true&$expand=observations($select=result,phenomenonTime;$expand=datastream;$orderby=phenomenonTime%20desc;$top=1)';

  // initialize the map
  var map = L.map('map').setView([52.1, 5.3], 8);

  L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
          }).addTo(map);

  // load GeoJSON from an external file
  $.getJSON(featuresurl,function(data){
    var options = {};
    // https://leafletjs.com/reference-1.5.0.html#circlemarker
    options.markerOptions = {
                          radius: 11,
                          //color: '#999999',
                          color: '#3498db',
                          fill: true,
                          fillOpacity: 1,
                          textStyle: {
                            color: '#000',
                            stroke: 'false',
                            fill: true,
                            _fontSize: '11',
                            _fontFamily: 'Helvetica, Arial, sans-serif'
                          },
                          shiftY: 7
                        };
    options.anchorOptions = {
      color: '#ff0000',
      radius: 1
    };
    options.getLabelText = function(marker, feature) {
      return feature.properties.value;
    };

    L.geoJson(data, {
      /*
      style: function (feature) {
        return feature.properties && feature.properties.style;
      },*/
      onEachFeature: function(feature, layer){
        layer.on('click', function(e){
          console.log(feature.properties.datastream_id)
          document.getElementById('dataframe').src = 'data.html?d='+feature.properties.datastream_id;
        })
      },
      pointToLayer: function (feature, latlng) {
        return new L.LabeledCircleMarker(latlng, feature, options);
      }
    }).addTo(map)
  });
});
</script>

</head>

<body>
<div id="map"></div>
<iframe id="dataframe" src="data.html"></iframe>
</body>

