<!DOCTYPE html>
<head>
<meta charset="utf-8">
<!-- leaflet map -->
<style>
  #map{ width:100%;height:400px; }

  body { font: 11px Arial;}

  iframe{
    width:100%;
    height: 300px;
    border: white
  }
</style>

<!-- https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.4.0/leaflet.js -->
<link rel="stylesheet" href="css/leaflet.css"/>
<script src="lib/leaflet.js"></script>
i<!-- https://github.com/w8r/leaflet-labeled-circle -->
<script src="lib/L.LabeledCircle.js"></script>
<!-- https://code.jquery.com/jquery-3.3.1.min.js -->
<script type="text/javascript" src="lib/jquery-3.3.1.min.js"></script>

<script>
$(function() {
  var featuresurl = window.location.protocol+'//'+window.location.hostname+'/cgi-bin/sta_proxy.py?$count=true&$expand=observations($select=result,phenomenonTime;$expand=datastream;$orderby=phenomenonTime%20desc;$top=1)';
  document.getElementById('dataurl').setAttribute('href', featuresurl);
  document.getElementById('dataurl').innerHTML = featuresurl;

  // initialize the map
  var map = L.map('map').setView([52.1, 5.3], 8);

  L.tileLayer(window.location.protocol+'//{s}.tile.osm.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
          }).addTo(map);

  // load GeoJSON from an external file
  $.getJSON(featuresurl,function(data){
    var options = {};
    // https://leafletjs.com/reference-1.5.0.html#circlemarker
    
    options.markerOptions = {
                          radius: 11,
                          //color: '#999999',
                          color: '#3498db',
                          fill: true,
                          fillOpacity: 1,
                          textStyle: {
                            color: '#000',
                            stroke: 'false',
                            fill: true,
                            _fontSize: '11',
                            _fontFamily: 'Helvetica, Arial, sans-serif'
                          },
                          shiftY: 7
                        };
    options.anchorOptions = {
      color: '#ff0000',
      radius: 1
    };
    options.getLabelText = function(marker, feature) {
      return feature.properties.value;
    };

    L.geoJson(data, {
      /*
      style: function (feature) {
        return feature.properties && feature.properties.style;
      },*/
      onEachFeature: function(feature, layer){
        layer.on('click', function(e){
          document.getElementById('dataframe').src = 'data.html?d='+feature.properties.datastream_id;
        });
      },
      pointToLayer: function (feature, latlng) {
        var marker = new L.LabeledCircleMarker(latlng, feature, options);
        var d = new Date(feature.properties.time);
        var popup = L.popup({ 'closeButton':false }).setContent('<div>'+d.toLocaleDateString('nl-NL', { 'dateStyle':'short'} )+'<br/>'
          +d.toLocaleTimeString('nl-NL', { 'timeStyle':'short'} )+'<br/><b>'+feature.properties.value+' '+feature.properties.unit+'</b></div>');
        marker.bindPopup(popup);
        //marker.bindPopup('<div>'+d.toLocaleDateString('nl-NL', { 'dateStyle':'short'} )+'<br/>'
        //  +d.toLocaleTimeString('nl-NL', { 'timeStyle':'short'} )+'<br/>'+feature.properties.value+' '+feature.properties.unit+'</div>');
        marker.on('mouseover', function (e) {
            this.openPopup();
        });
        marker.on('mouseout', function (e) {
            this.closePopup();
        });
        return marker;
      }
    }).addTo(map)
  });
});
</script>

</head>

<body>
<p> Data url = <a id="dataurl" href="">todo</a> </p>
<div id="map"></div>
<iframe id="dataframe" src="data.html"></iframe>
</body>

